<!DOCTYPE html>
<html lang="en">
		<head>
				<title>Snakes, Ladders and Numbers
				</title>
				<meta name="viewport"        content="width=device-width, initial-scale=1">
				<link href="game.css" rel="stylesheet">
				<script type="text/javascript" src="utilities.js"></script></head>
		<body>
			<div class="menu">
		<button id="upgrade"><span>Upgrade</span>	<button id="play"><span>Play</span>
					<button id="resume"><span>Resume</span>
<button id="high-score"><span>High Score</span>			<button id="help"><span>Help</span></div>			
<div class="z-order">	
			 <div class="top-container">
		  		<div class="flex-item-score">SCORE: 0</div>
		 <div><img class="confirm" src=""  alt=""></div><div class="flex-item-time">
		  				TIME: 060
		  		</div>
		  	</div>
		  	<div class="board-container">
			   <img id="board" src="board.png" alt="game board">
				</div>
			 <button id="gen">Generate</button>
		<span id="exp"><strong>5 + 8  </strong></span></div>	
		
			<img class="splash" src="splash02.png"><!-- <h1 id="intro-text">Click to start!</h1>1 -->
		<div class="dialog">
				<div style="color:red; margin: auto auto;text-align:center;font-weight: bold">Choose level of difficulty</div>
				<span id="easy" style="display:inline-block;margin: 10vw 10vw 25vw 20vw;transform: rotate(-35deg);background:rgba(255,255,255,0.5);border-radius:20%;padding: 5px;">Easy</span>
	     <span id="hard" style="display:inline-block;margin:0;transform:rotate(-35deg);border-radius:20%;padding:5px;">Hard</span>		</div>
	     <img src="gameover.png" class="game-over" alt="game over image">
				<audio id="game_sound">
				 <source src="app_src_main_res_raw_intro.mp3" type="audio/mpeg"></audio>
		<div class="score-sheet">
				<span id="score-label">Precision</span>
				<span id="score-amount">1000000</span>
     	<span id="time-label">Time Bonus</span>
				<span id="time-bonus">10000</span>
      	<span id="final-scorelabel">Final Score</span>
				<span id="final-score">1000000</span>
			<button id="register"><span>Register your score!</span></button>	<button id="close"><span>Close</span></button></div>	
<div class="score-screen-container">
<div class="score-screen"	>
			<h2 id="high-scores-title">HIGH SCORES</h2>
		<span id="pos-one"></span>
				<span id="pos-one-score"></span>
     	<span id="pos-two"></span>
				<span id="pos-two-score"></span>
      	<span id="pos-three"></span>
				<span id="pos-three-score"></span>
		   	<span id="pos-four"></span>
				<span id="pos-four-score"></span>
		   	<span id="pos-five"></span>
				<span id="pos-five-score"></span>
			<button id="close-scores"><span>Back</span></button>		</div>
   <div class="initials">
				<div class="name">
				<form>
						<label for="username">Enter your initials</label><br>
				<input type="text" id="username" name="username" maxlength="6" placeholder="username" required></div>
				<input type="hidden" id="high_score">
		   <button id="submitUserName" onclick="showInitials()">Finnish</button>		   
   </div>
	
<script src="globals.js"></script>
			<script  src="test.js"></script>
	 <script  src="game.js"></script>
	<script type="text/javascript">		
function isEqualToTrue(s, text = "true"){
  const index = s.indexOf(text)
  return s.substring(index, index + text.length) === text
}
	
function getStateCookieData(state){	
		gameState.difficulty = state[0]
  	gameState.gameOver = isEqualToTrue(state[1]) 
   gameState.score = parseInt(state[2])
   gameState.time = parseInt(state[3])
   gameState.index = parseInt(state[4])
   gameState.correct = parseInt(state[5])
   gameState.numOfMoves = parseInt(state[6])	
	}

 
const defaultScores = {}
defaultScores.initials  = [...recordedScores.initials]
defaultScores.scores  = [...recordedScores.scores]

function loadDefaultScores(){
	for(let i = 0; i < 5; i++){
    recordedScores.initials[i] = defaultScores.initials[i]
     recordedScores.scores[i] = defaultScores.scores[i]
  } 	
  console.log(`default = ${JSON.stringify(recordedScores)}`)
}

function storeScores(recordedScores, scoreData){
     const scores = scoreData.split(",") 
    for(let i = 0; i < 5; i++){
     recordedScores.initials[i] = scores[i].substring(0, scores[i].indexOf(" ")) 
     recordedScores.scores[i] = scores[i].substring(scores[i].indexOf(" ") + 1)
 }
}

function loadHighScores(){
 const cookieValue = checkCookie("scores", "AAA 5000,BBB 4000,CCC 3000,DDD 2000,EEE 1000")		
 if(cookieValue != "")	{
 //TODO
 // Put into separate function 
    const scores = cookieValue.split(",") 
    for(let i = 0; i < 5; i++){
     recordedScores.initials[i] = scores[i].substring(0, scores[i].indexOf(" ")) 
     recordedScores.scores[i] = scores[i].substring(scores[i].indexOf(" ") + 1)
    }  
  }else{  
    loadDefaultScores()
  }				
}	

const initialsIds = ["#pos-one", "#pos-two", "#pos-three", "#pos-four", "#pos-five"]
Object.freeze(initialsIds)
const scoresIds = ["#pos-one-score", "#pos-two-score", "#pos-three-score", "#pos-four-score", "#pos-five-score"]
Object.freeze(scoresIds)

function displayScores(){ 
  for(let i = 0; i < 5; i++){
document.querySelector(initialsIds[i]).innerHTML = `${i+1}. ${recordedScores.initials[i]}`
document.querySelector(scoresIds[i]).innerHTML = recordedScores.scores[i]
  }
}

window.addEventListener("load", e => {
// Get the previous game state from cookie
  let name = checkCookie("gameState",`"easy",${true},0,0,0,0,0`)
  if(name != ""){
   getStateCookieData(name.split(","))
  }
   resumeButton.disabled =   gameState.gameOver
})

const screens = {menu: document.querySelector(".menu"), 
level: document.querySelector(".z-order"),
introScreen: document.querySelector(".splash"),
highScores: document.querySelector(".score-screen-container"), choiceDialog: document.querySelector(".dialog"),
 scoreBonus: document.querySelector(".score-sheet"), gameOverText: document.querySelector(".game-over"),
 button: document.querySelector("#gen")}
 
 function beginPlay(){ 
	setTimeout(()=> {
    game.started = true 
		eventTarget.audio.pause()}, 1000)		
	window.requestAnimationFrame(loop)
 }

 function menuFadeOut(){
 	 eventTarget.audio.play()
   screens.introScreen.style.left = "0"
    screens.choiceDialog.style.left="10vw"       
screens.menu.classList.add("splash-fadeout")
 }
 
screens.menu.addEventListener("animationend", e => { 
    screens.menu.style.top = "100vh"
 }, false)
 
 function chooseMode(mode){
 	const black = "rgba(0,0,0,0.0)"
 	const white = "rgba(255,255,255,0.5)"
 	let easy = easyMode.style
 	let hard = hardMode.style
 	if(mode==="easy"){ 
 	  easy.background = white
 	  hard.background = black 
 	  easy.color="rgba(255,0,0,1.0)"
 	}else{
 		easy.background = black
 	  hard.background = white
 	  hard.color="rgba(255,0,0,1.0)"
   }	
 }
 
 function setDefaultState(){
   gameState.gameOver = false
   gameState.difficulty = "easy"
   gameState.score = 0
   gameState.time = 60
   gameState.index = 0 
   gameState.correct = 0 
   gameState.numOfMoves = 0
 }
 
// Proceed to title screen
playButton.addEventListener("click", e =>{ 
 setDefaultState()
 menuFadeOut()
 })

// Resume play 
resumeButton.addEventListener	("click", e =>{ 
  menuFadeOut()
	chooseMode(gameState.difficulty)			  
  phaseOut(eventTarget,  gameState.difficulty)
	})

function phaseOut(target, mode){
  gameMode = mode === "easy" ? "easy": "hard"
screens.choiceDialog.classList.add("splash-fadeout") 
screens.introScreen.classList.add("splash-fadeout")
 }

// Event listeners for chosen game mode
easyMode.addEventListener("click", e => { 
 screens.level.style.visibility = "visible"
  gameState.difficulty = "easy"
  chooseMode("easy")
  phaseOut(eventTarget, "easy")
 })
 
hardMode.addEventListener("click", e => {  
screens.level.style.visibility  = "visible" 
  gameState.difficulty = "hard"
  chooseMode("hard") 
  phaseOut(eventTarget, "hard")
 })

// Initializes the game state
function startGame(targets, mode, rand, screen){
  game = new Game(targets, mode, rand, gameState, screen)
  game.initializeGrid()
  game.positionPlayer()
  game.init(recordedScores)
 }	

// View high scores
const menuToScores =  document.querySelector(".score-screen-container") 
highScoreButton.addEventListener("click",e => { 
  loadHighScores()		
  displayScores()	
 		screens.menu.style.top = "100vh"
 		screens.highScores.style.left ="0"
	})

// Return to menu screen from high score screen
const scoresToMenu = document.querySelector("#close-scores") 		
scoresToMenu.addEventListener("click", e => {
  	screens.menu.style.top ="0"
 		screens.highScores.style.left="-100vw"		
})

// Game loop 
let gameTime = gameState.time * 1000
function loop(timestamp){
	if(startTime == undefined)
		 startTime = timestamp
		
	const elapsed = timestamp - startTime;
	if(previousTime !== timestamp){
		 let time = Math.min(0.001 * elapsed, gameTime)
  if(!game.started){
	    startTime = undefined
      time = 0
      game.update(time)
   }else{
	  	 game.update(time)
  }
	if(elapsed < gameTime){
				previousTime = timestamp
		window.requestAnimationFrame(loop)
		}
 }		
}// end loop

// Event handler for starting gameplay
screens.introScreen.addEventListener("animationend", e => { 
  screens.introScreen.style.left = "100vw"
  screens.choiceDialog.style.left= "110vw"
   beginPlay()
 }, false)
 
// Start splash screen fadeout
screens.introScreen.addEventListener("animationstart", e => { 
screens.level.style.left = "0"	
  startGame(eventTarget, gameState.difficulty, (lower, upper) => {
    const range = upper - lower + 1
    const num1 = Math.floor(Math.random() * range) + lower
    const num2 = Math.floor(Math.random() * range) + lower
    return [num1, num2]
  }, screens)					
 }, false)

function findMaximumPosition(score, initials, records){
	 // Find position to insert the score
   let y // temporary variable fo value at insertion position
   let z // temp variable to hold initials
   let index // position to insert score
   for(let i = 0; i < 5; i++)	{
   		if(parseInt(score) > parseInt(records.scores[i])){
   			index = i
   			y = records.scores[i]	
   			z = records.initials[i]
   			records.scores[i] = `${score}`
   			records.initials[i] = `${initials}`
   			break   			
   		}// if
   } // for
   index++ // Advance position for swapping
   return {pos: index,temp: y, temp2: z}
}

function showInitials(){
  const userInput = document.getElementById("username").value
  const score = document.querySelector("#high_score") 
 // Update the high scores 
  let {pos, temp, temp2} = findMaximumPosition(score.value, userInput, recordedScores) 
  for(let i = pos; i < 5; i++)	{
    let x = recordedScores.scores[i]
    recordedScores.scores[i] = temp
    temp = x
    // Swap initials
    let y = recordedScores.initials[i]
    recordedScores.initials[i] = temp2
    temp2 = y
   }
  // Store the high scores
   let scoreRecords = storeRecentScore() 
   setCookie("scores", storeRecords)

   backToMenu()   
}

function storeRecentScore(){
   let value = ""
   for(let i = 0; i < 5; i++){
      value += `${recordedScores.initials[i]} ${recordedScores.scores[i]},`
   }
   value = value.substring(0, value.length-1)
   return value
}

function backToMenu(){
  const playerInitials = document. querySelector(".initials")
  playerInitials.style.top = "35vw"
  playerInitials.style.left = "500vw" 
  screens.menu.style.top = "0" 
  window.location.reload()
}

let game; //Game board state and operatiop1
let gameMode = "easy"
let startTime //Current delta time 
let previousTime // Previous delta time
// Game objects 
const eventTarget = new EventTarget()

// Splash screen intro music
const intro = eventTarget.audio
intro.src = sounds[3]
   </script>
</body>
</html>




